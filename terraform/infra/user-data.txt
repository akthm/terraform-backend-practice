#!/usr/bin/env bash
set -euxo pipefail

sudo yum update -y
sudo yum install -y git jq

# Create actions user
sudo useradd -m -s /bin/bash actions
sudo mkdir -p /actions && sudo chown actions:actions /actions

# (Optional) CloudWatch Agent for logs
# ...

RUNNER_VERSION="2.317.0"
RUNNER_DIR="/actions/runner"
sudo -u actions bash -lc "mkdir -p ${RUNNER_DIR} && cd ${RUNNER_DIR}
curl -L -o actions-runner.tar.gz https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-x64-${RUNNER_VERSION}.tar.gz
tar xzf actions-runner.tar.gz"

# Retrieve a short-lived registration token (recommended: store GH PAT in SSM and fetch it here)
# GH_TOKEN should have minimal scope to create a runner registration token.
OWNER="your-org-or-user"
REPO="your-repo"
GH_TOKEN_SSM_PARAM="/github/pat"
GH_TOKEN=$(aws ssm get-parameter --name "${GH_TOKEN_SSM_PARAM}" --with-decryption --query 'Parameter.Value' --output text || true)
REG_TOKEN=$(curl -sX POST -H "Authorization: token ${GH_TOKEN}" https://api.github.com/repos/${OWNER}/${REPO}/actions/runners/registration-token | jq -r .token)

sudo -u actions bash -lc "cd ${RUNNER_DIR}
./config.sh --unattended \
  --url https://github.com/${OWNER}/${REPO} \
  --token ${REG_TOKEN} \
  --labels ec2,terraform,private \
  --name $(hostname) \
  --work /actions/_work \
  --replace"

sudo ${RUNNER_DIR}/svc.sh install actions
sudo ${RUNNER_DIR}/svc.sh start
